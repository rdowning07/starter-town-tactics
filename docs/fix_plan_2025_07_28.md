# 🛠️ Fix Plan: Test Failures and Refactor Tracking (2025-07-28)

This document outlines the current test failures, their root causes, and the prioritized fix plan. It reflects the state after the `make clean && make test` run on July 28, 2025.

---

## ✅ Status Overview

- **Total Tests**: 39
- **Passing**: 22
- **Failing**: 17
- **Coverage**: 73%

---

## 🔴 Failing Tests Breakdown

| Test File | Failure | Root Cause |
|-----------|---------|------------|
| `test_game.py` | `test_add_unit`, `test_game_turns` | `Game` missing `add_unit()` and `current_turn` |
| `test_gamepad_controller.py` | `test_gamepad_movement_buttons` | `GamepadController.update()` has wrong signature |
| `test_grid.py` | `test_terrain_movement_costs` | Terrain type or cost mismatch |
| `test_grid_output.py` | `test_ascii_output_with_title`, `test_ascii_output_without_title` | `Grid.print_ascii()` missing |
| `test_input_state.py` | 4 tests | `InputState` missing `game.grid`, `key_states` |
| `test_keyboard_controller.py` | `test_key_press_tracking` | `InputState.key_states` missing |
| `test_mcp.py` | `test_mouse_and_key_input` | `InputState.key_states` missing |
| `test_sim_runner.py` | `test_simulation_run` | `Game.add_unit()` missing |
| `test_tile.py` | `test_tile_symbol_for_forest_and_mountain` | Unexpected symbol for unknown terrain |
| `test_turn_controller.py` | `test_turn_cycle` | `TurnController.__init__()` missing `game` argument |
| `test_unit.py` | `test_unit_move_to` | `Unit.move_to()` missing |
| `test_unit_terrain_cost.py` | `test_unit_movement_within_terrain_cost` | `Unit.move()` logic allows costly move |

---

## 🧱 Modules Needing Immediate Regeneration

### 1. `game/game.py`
- [x] `add_unit(unit: Unit)`
- [x] `current_turn` property
- [x] `grid` property
- [x] `units` list

### 2. `game/turn_controller.py`
- [x] Accept `game` in constructor
- [x] `end_turn()`, `is_ai_turn()` logic

### 3. `game/grid.py`
- [x] `print_ascii(show_title=True|False)` method

### 4. `game/input_state.py`
- [x] `key_states: set[str]`
- [x] `game.grid` assumed valid
- [x] `confirm_selection()`

### 5. `game/unit.py`
- [x] `move_to(x, y, grid)`

### 6. `game/gamepad_controller.py`
- [x] `update(events: set[int])` needs correct signature

### 7. `game/tile.py`
- [x] `get_symbol()` should return `"."` for unknown terrain

---

## 📋 Next Regeneration Targets

- [ ] `input_state.py`
- [ ] `keyboard_controller.py`
- [ ] `mcp.py`
- [ ] `tile.py` (symbol fix)
- [ ] `grid.py` (ASCII output fix)
- [ ] `test_*` validation after each module fix

---

## 🔄 To Do

- [ ] Regenerate and confirm `game/game.py`
- [ ] Regenerate failing modules in order
- [ ] After each fix, run:
  ```bash
  make clean
  make test
  make typecheck
  make lint
